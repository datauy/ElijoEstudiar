/*
 * ion-autocomplete 0.4.0
 * Copyright 2017 Danny Povolotski 
 * Copyright modifications 2017 Guy Brand 
 * https://github.com/guylabs/ion-autocomplete
 */
!function(){"use strict";angular.module("ion-autocomplete",[]).directive("ionAutocomplete",["$ionicBackdrop","$ionicScrollDelegate","$document","$q","$parse","$interpolate","$ionicPlatform","$compile","$templateRequest",function(a,b,c,d,e,f,g,h,i){return{require:["ngModel","ionAutocomplete"],restrict:"A",scope:{},bindToController:{ngModel:"=",externalModel:"=",templateData:"=",maxSelectedItems:"=",itemsMethod:"&",itemsClickedMethod:"&",itemsRemovedMethod:"&",modelToItemMethod:"&",cancelButtonClickedMethod:"&",placeholder:"@",cancelLabel:"@",selectItemsLabel:"@",selectedItemsLabel:"@",templateUrl:"@",itemValueKey:"@",itemViewValueKey:"@"},controllerAs:"viewModel",controller:["$attrs","$timeout","$scope",function(a,b,c){var d=function(a,b){return a?a:b},e=this;b(function(){e.placeholder=d(e.placeholder,"Click to enter a value..."),e.cancelLabel=d(e.cancelLabel,"Done"),e.selectItemsLabel=d(e.selectItemsLabel,"Select an item..."),e.selectedItemsLabel=d(e.selectedItemsLabel,f("Selected items{{maxSelectedItems ? ' (max. ' + maxSelectedItems + ')' : ''}}:")(e)),e.templateUrl=d(e.templateUrl,void 0),e.itemValueKey=d(e.itemValueKey,void 0),e.itemViewValueKey=d(e.itemViewValueKey,void 0)}),this.itemsMethodValueKey=d(a.itemsMethodValueKey,void 0),this.componentId=d(a.componentId,void 0),this.loadingIcon=d(a.loadingIcon,void 0),this.manageExternally=d(a.manageExternally,"false"),this.clearOnSelect=d(a.clearOnSelect,"true"),this.ngModelOptions=d(c.$eval(a.ngModelOptions),{}),this.openClass=d(a.openClass,"ion-autocomplete-open"),this.closeClass=d(a.closeClass,"ion-autocomplete-close"),this.showLoadingIcon=!1,this.searchItems=[],this.selectedItems=[],this.searchQuery=void 0,this.isArray=function(a){return angular.isArray(a)}}],link:function(j,k,l,m){var n=m[0],o=m[1];o.randomCssClass="ion-autocomplete-random-"+Math.floor(1e3*Math.random()+1);var p=['<div class="ion-autocomplete-container '+o.randomCssClass+" modal "+o.closeClass+' " >','<div class="bar bar-header item-input-inset">','<label class="item-input-wrapper">','<i class="icon ion-search placeholder-icon"></i>','<input type="search" class="ion-autocomplete-search" ng-model="viewModel.searchQuery" ng-model-options="viewModel.ngModelOptions" placeholder="{{viewModel.placeholder}}"/>',"</label>",'<div class="ion-autocomplete-loading-icon" ng-if="viewModel.showLoadingIcon && viewModel.loadingIcon"><ion-spinner icon="{{viewModel.loadingIcon}}"></ion-spinner></div>','<button class="ion-autocomplete-cancel button button-clear button-dark" ng-click="viewModel.cancelClick()">{{viewModel.cancelLabel}}</button>',"</div>",'<ion-content class="has-header">','<ion-item class="item-divider">{{viewModel.selectedItemsLabel}}</ion-item>','<ion-item ng-if="viewModel.isArray(viewModel.selectedItems)" ng-repeat="selectedItem in viewModel.selectedItems track by $index" class="item-icon-left item-icon-right item-text-wrap">','<i class="icon ion-checkmark"></i>',"{{viewModel.getItemValue(selectedItem, viewModel.itemViewValueKey)}}",'<i class="icon ion-trash-a" style="cursor:pointer" ng-click="viewModel.removeItem($index)"></i>',"</ion-item>",'<ion-item ng-if="!viewModel.isArray(viewModel.selectedItems)" class="item-icon-left item-icon-right item-text-wrap">','<i class="icon ion-checkmark"></i>',"{{viewModel.getItemValue(viewModel.selectedItems, viewModel.itemViewValueKey)}}",'<i class="icon ion-trash-a" style="cursor:pointer" ng-click="viewModel.removeItem(0)"></i>',"</ion-item>",'<ion-item class="item-divider" ng-if="viewModel.searchItems.length > 0">{{viewModel.selectItemsLabel}}</ion-item>','<ion-item ng-repeat="item in viewModel.searchItems track by $index" item-height="55px" item-width="100%" ng-click="viewModel.selectItem(item)" class="item-text-wrap">',"{{viewModel.getItemValue(item, viewModel.itemViewValueKey)}}","</ion-item>","</ion-content>","</div>"].join("");d.when().then(function(){return o.templateUrl?i(o.templateUrl):p}).then(function(i){var m=h(angular.element(i))(j);c.find("body").append(m),o.getItemValue=function(a,b){if(angular.isArray(a)){var c=[];return angular.forEach(a,function(d){b&&angular.isObject(a)?c.push(e(b)(d)):c.push(d)}),c}return b&&angular.isObject(a)?e(b)(a):a},o.selectItem=function(a){"true"==o.clearOnSelect&&(o.searchQuery=void 0),"1"!=o.maxSelectedItems&&angular.isArray(o.selectedItems)&&o.maxSelectedItems<=o.selectedItems.length||(u(o.selectedItems,o.itemValueKey,o.getItemValue(a,o.itemValueKey))||("1"==o.maxSelectedItems?o.selectedItems=a:o.selectedItems=o.selectedItems.concat([a])),n.$setViewValue(o.selectedItems),n.$render(),1==o.maxSelectedItems&&o.hideModal(),angular.isDefined(l.itemsClickedMethod)&&o.itemsClickedMethod({callback:{item:a,selectedItems:angular.isArray(o.selectedItems)?o.selectedItems.slice():o.selectedItems,selectedItemsArray:angular.isArray(o.selectedItems)?o.selectedItems.slice():[o.selectedItems],componentId:o.componentId}}))},o.removeItem=function(a){if(angular.isArray(o.selectedItems)){var b=o.selectedItems.splice(a,1)[0];o.selectedItems=o.selectedItems.slice()}else o.selectedItems=[];n.$setViewValue(o.selectedItems),n.$render(),angular.isDefined(l.itemsRemovedMethod)&&o.itemsRemovedMethod({callback:{item:b,selectedItems:angular.isArray(o.selectedItems)?o.selectedItems.slice():o.selectedItems,selectedItemsArray:angular.isArray(o.selectedItems)?o.selectedItems.slice():[o.selectedItems],componentId:o.componentId}})},j.$watch("viewModel.searchQuery",function(a){o.fetchSearchQuery(a,!1)}),j.$watch("viewModel.maxSelectedItems",function(a){o.maxSelectedItems!=a&&(o.selectedItemsLabel=f("Selected items{{maxSelectedItems ? ' (max. ' + maxSelectedItems + ')' : ''}}:")(o))}),o.fetchSearchQuery=function(a,c){if(void 0!==a&&angular.isDefined(l.itemsMethod)){o.showLoadingIcon=!0;var e={query:a,isInitializing:c};o.componentId&&(e={query:a,isInitializing:c,componentId:o.componentId});var f=d.when(o.itemsMethod(e));f.then(function(a){a&&(a&&a.data&&(a=a.data),o.searchItems=o.getItemValue(a,o.itemsMethodValueKey),b.resize())},function(a){return d.reject(a)}).finally(function(){o.showLoadingIcon=!1})}};var p=!1;o.showModal=function(){if(!p){a.retain();var d=angular.element(c[0].querySelector("div.ion-autocomplete-container."+o.randomCssClass));d.addClass(this.openClass),d.removeClass(this.closeClass),j.$deregisterBackButton=g.registerBackButtonAction(function(){o.hideModal()},300);var e=angular.element(c[0].querySelector("div.ion-autocomplete-container."+o.randomCssClass+" input"));e.length>0&&(e[0].focus(),setTimeout(function(){e[0].focus()},100)),b.resize(),p=!0}},o.hideModal=function(){var b=angular.element(c[0].querySelector("div.ion-autocomplete-container."+o.randomCssClass));b.addClass(this.closeClass),b.removeClass(this.openClass),o.searchQuery=void 0,a.release(),j.$deregisterBackButton&&j.$deregisterBackButton(),p=!1};var q={moved:!1,startX:0,startY:0},r=function(a){q.moved=!1,"undefined"!=typeof a.originalEvent&&(a=a.originalEvent),q.startX=a.touches[0].clientX,q.startY=a.touches[0].clientY},s=function(a){"undefined"!=typeof a.originalEvent&&(a=a.originalEvent),(Math.abs(a.touches[0].clientX-q.startX)>10||Math.abs(a.touches[0].clientY-q.startY)>10)&&(q.moved=!0)},t=function(a){q.moved||(a.preventDefault(),a.stopPropagation(),o.fetchSearchQuery("",!0),o.showModal())},u=function(a,b,c){if(angular.isArray(a))for(var d=0;d<a.length;d++)if(o.getItemValue(a[d],b)===c)return!0;return!1},v=function(a){var b=d.when(o.modelToItemMethod({modelValue:a}));b.then(function(a){o.selectItem(a)},function(a){return d.reject(a)})};"false"==o.manageExternally&&(k.bind("touchstart",r),k.bind("touchmove",s),k.bind("touchend click focus",t)),o.cancelClick=function(){o.hideModal(),angular.isDefined(l.cancelButtonClickedMethod)&&o.cancelButtonClickedMethod({callback:{selectedItems:angular.isArray(o.selectedItems)?o.selectedItems.slice():o.selectedItems,selectedItemsArray:angular.isArray(o.selectedItems)?o.selectedItems.slice():[o.selectedItems],componentId:o.componentId}})},j.$watch("viewModel.externalModel",function(a){return angular.isArray(a)&&0==a.length?(o.selectedItems=[],n.$setViewValue(o.selectedItems),void n.$render()):void(a&&angular.isDefined(l.modelToItemMethod)&&(angular.isArray(a)?(o.selectedItems=[],angular.forEach(a,function(a){v(a)})):v(a)))}),j.$on("$destroy",function(){a.release(),m.remove()}),n.$render=function(){k.val(o.getItemValue(n.$viewValue,o.itemViewValueKey))},n.$formatters.push(function(a){var b=o.getItemValue(a,o.itemViewValueKey);return void 0==b?"":b}),n.$parsers.push(function(a){return o.getItemValue(a,o.itemValueKey)})})}}}])}();